name: release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Build version (e.g. 1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  guard:
    runs-on: ubuntu-latest
    if: ${{ github.ref_name != 'main' }}
    steps:
      - run: |
          echo "This workflow may only be run on main"
          exit 1

  version:
    needs:
      - guard
    outputs:
      tag: ${{ steps.tag_generation.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate tag
        id: tag_generation
        run: |
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format"
            exit 1
          fi
          
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ inputs.version }}

  changes:
    needs: guard
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.detect.outputs.backend }}
      frontend: ${{ steps.detect.outputs.frontend }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changes since last release
        id: detect
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Last tag: $LAST_TAG"

          if [ -z "$LAST_TAG" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if git diff --name-only "$LAST_TAG"..HEAD | grep -q '^aoc/backend/'; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only "$LAST_TAG"..HEAD | grep -q '^aoc/frontend/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

  build-and-push-backend:
    needs:
      - guard
      - version
      - changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            **/build
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Determine tag
        run: echo "TAG_NAME=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Print tag
        run: echo "Tag is ${TAG_NAME}"
      - name: Build with Gradle
        run: ./gradlew clean build -x test -PprojVersion=${TAG_NAME}
        working-directory: aoc/backend

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: aoc/backend
          file: aoc/backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.actor }}/backend:${{ needs.version.outputs.tag }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.actor }}/backend
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  build-and-push-frontend:
    needs:
      - guard
      - version
      - changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Determine tag
        run: echo "TAG_NAME=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Print tag
        run: echo "Tag is ${TAG_NAME}"
      - name: Cache npm files
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-npm-files
        with:
          path: |
            ~/.npm
            aoc/frontend/node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list

      - name: Build frontend
        run: |
          npm ci
          npm run build
        working-directory: aoc/frontend

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: aoc/frontend
          file: aoc/frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.actor }}/frontend:${{ needs.version.outputs.tag }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.actor }}/frontend
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  create-release:
    needs:
      - guard
      - version
      - changes
      - build-and-push-backend
      - build-and-push-frontend
    if: |
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Create Git tag & GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          TAG="v${{ needs.version.outputs.tag }}"
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists"
            exit 0
          fi
          
          git tag "$TAG"
          git push origin "$TAG"
          
          gh release create "$TAG" --generate-notes

  deploy-prod-backend:
    if: needs.changes.outputs.backend == 'true'
    needs:
      - version
      - changes
      - create-release
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.actor }}/backend:${{ needs.version.outputs.tag }}
            docker compose up -d

  deploy-prod-frontend:
    needs:
      - version
      - changes
      - create-release
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.actor }}/frontend:${{ needs.version.outputs.tag }}
            docker compose up -d
