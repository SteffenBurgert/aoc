name: pipeline
on:
  push:
  workflow_dispatch:
    inputs:
      version:
        description: 'Build version (e.g. 1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  version:
    outputs:
      tag: ${{ steps.tag_generation.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate tag
        id: tag_generation
        run: |
          PIPELINE_NUMBER=${{ github.run_number }}
          EVENT_NAME="${{ github.event_name }}"
          REF_NAME="${{ github.ref_name }}"
          
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Invalid version format"
              exit 1
            fi
          fi
          
          if [[ "$EVENT_NAME" == "workflow_dispatch" && ( "$REF_NAME" == "main" || "$REF_NAME" == hotfix* || "$REF_NAME" == release* ) ]]; then            
            NEW_TAG="${VERSION}"
          else
            NEW_TAG="$(date +'%Y-%m-%d').${PIPELINE_NUMBER}"
          fi
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ inputs.version }}

  build-and-push-backend:
    needs:
      - version
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      # Cache Gradle dependencies (including wrapper) and build outputs
      - name: Cache Gradle caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            **/build
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Determine tag
        run: echo "TAG_NAME=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Print tag
        run: echo "Tag is ${TAG_NAME}"
      - name: Build with Gradle
        run: ./gradlew clean build -x test -PprojVersion=${TAG_NAME}
        working-directory: backend

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.actor }}/backend
          tags: |
            type=raw,value=${{ needs.version.outputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.actor }}/backend
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  build-and-push-frontend:
    needs:
      - version
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Determine tag
        run: echo "TAG_NAME=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Print tag
        run: echo "Tag is ${TAG_NAME}"
      - name: Cache npm files
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-npm-files
        with:
          path: |
            ~/.npm
            frontend/node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Build
        run: npm run build
        working-directory: frontend

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.actor }}/frontend
          tags: |
            type=raw,value=${{ needs.version.outputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.actor }}/frontend
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  create_release:
    if: ${{ github.event_name == 'workflow_dispatch' && (github.ref_name == 'main' || startsWith(github.ref_name, 'hotfix') || startsWith(github.ref_name, 'release')) }}
    needs:
      - version
      - build-and-push-backend
      - build-and-push-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Determine release tag
        run: echo "RELEASE_TAG=v${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Push new tag
        run: |
          if git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Tag already exists"
          else
            git tag "${RELEASE_TAG}"
            git push origin "${RELEASE_TAG}"
          fi
      - name: Create GitHub Release
        run: gh release create ${RELEASE_TAG} --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-prod:
    if: ${{ github.event_name == 'workflow_dispatch' && (github.ref_name == 'main' || startsWith(github.ref_name, 'hotfix') || startsWith(github.ref_name, 'release')) }}
    needs:
      - version
      - build-and-push-backend
      - build-and-push-frontend
      - create_release
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.actor }}/backend:${{ needs.version.outputs.tag }}
            docker pull ghcr.io/${{ github.actor }}/frontend:${{ needs.version.outputs.tag }}
            docker compose up -d
